<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</title>
    <link rel="stylesheet" href="/src/export.css">
</head>

<body>
    <!-- â˜… å…¨ä½“ã‚’å›²ã‚€ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’è¿½åŠ  -->
    <div id="export-wrapper">

        <!-- ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒ¼ -->
        <div data-tauri-drag-region class="export-titlebar no-print">
            <div class="export-controls">
                <!-- è¨­å®šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ  -->
                <select id="font-select" title="ãƒ•ã‚©ãƒ³ãƒˆ" style="height: 22px;">
                    <option value="serif">æ˜æœ (Serif)</option>
                    <option value="sans-serif">ã‚´ã‚·ãƒƒã‚¯ (Sans)</option>
                    <option value="monospace">ç­‰å¹…</option>
                    <!-- å¿…è¦ãªã‚‰ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆã‚‚ã“ã“ã«è¿½åŠ  -->
                </select>

                <input type="number" id="font-size" value="16" min="8" max="72" title="ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º (px)"
                    style="width: 40px;">

                <label title="è¡Œé–“"><span style="color:white; font-size:0.8em;"></span>
                    <input type="number" id="line-height" value="1.8" min="1.0" max="3.0" step="0.1"
                        style="width: 40px;">
                </label>

                <span style="border-left: 1px solid #666; margin: 0 10px;"></span>

                <button id="btn-print" title="å°åˆ· / PDFä¿å­˜(Ctrl+P)">ğŸ–¨ï¸</button>
                <button id="btn-html" title="HTMLä¿å­˜">HTML</button>
                <button id="btn-epub" title="EPUBä¿å­˜">EPUB</button>
                <button id="btn-close" title="é–‰ã˜ã‚‹(Ctrl+E)">Ã—</button>
            </div>
        </div>

        <!-- åŸç¨¿ã‚¨ãƒªã‚¢ -->
        <div id="print-container">
            <div id="paper-area">
                <div id="content"></div>
            </div>
        </div>
        <!-- EPUBè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="epub-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <h3>EPUBå‡ºåŠ›è¨­å®š</h3>

                <div class="modal-item">
                    <label>ã‚¿ã‚¤ãƒˆãƒ«:</label>
                    <input type="text" id="epub-title" placeholder="ä½œå“å">
                </div>

                <div class="modal-item">
                    <label>è‘—è€…å:</label>
                    <input type="text" id="epub-author" placeholder="è‘—è€…å" value="Author">
                </div>

                <div class="modal-item">
                    <label>è¡¨ç´™ç”»åƒ (ä»»æ„):</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" id="epub-cover-path" readonly placeholder="æœªé¸æŠ">
                        <button id="btn-select-cover">é¸æŠ</button>
                        <button id="btn-clear-cover">Ã—</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button id="btn-cancel-epub">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button id="btn-exec-epub" class="primary">ä¿å­˜...</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ¨å¥¨) -->
    <script type="module">
        import { listen, emit } from '@tauri-apps/api/event';
        import { invoke } from '@tauri-apps/api/core';
        import { getCurrentWindow } from '@tauri-apps/api/window';
        import { open, save } from '@tauri-apps/plugin-dialog';
        import updateArticle from '/src/scripts/ruby.ts';

        async function initExport() {
            const contentDiv = document.getElementById('content');
            const fontSelect = document.getElementById('font-select');
            const fontSizeInput = document.getElementById('font-size');
            const lineHeightInput = document.getElementById('line-height');
            const epubModal = document.getElementById('epub-modal');
            const epubTitleInput = document.getElementById('epub-title');
            const epubAuthorInput = document.getElementById('epub-author');
            const epubCoverPathInput = document.getElementById('epub-cover-path');

            // ãƒ‡ãƒ¼ã‚¿å—ä¿¡
            await listen('export-data', (event) => {
                const { text } = event.payload;
                if (contentDiv) {
                    // 1. åŸºæœ¬çš„ãªæ”¹è¡Œå¤‰æ›
                    contentDiv.innerHTML = text.replace(/\n/g, '<br>');
                    // 2. ãƒ«ãƒ“å¤‰æ›ã‚’å®Ÿè¡Œ
                    updateArticle(contentDiv);
                    updateStyles();
                }
            });

            // --- ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°é–¢æ•° ---
            function updateStyles() {
                if (!contentDiv) return;
                const font = fontSelect.value;
                const size = fontSizeInput.value;
                const lh = lineHeightInput.value;

                contentDiv.style.fontFamily = font === 'serif' ? '"Yu Mincho", serif' :
                    font === 'sans-serif' ? '"Hiragino Sans", sans-serif' : 'monospace';
                contentDiv.style.fontSize = `${size}px`;
                contentDiv.style.lineHeight = lh;
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            fontSelect.addEventListener('change', updateStyles);
            fontSizeInput.addEventListener('input', updateStyles);
            lineHeightInput.addEventListener('input', updateStyles);

            // ãƒ‡ãƒ¼ã‚¿è¦æ±‚ (èµ·å‹•ç›´å¾Œ)
            setTimeout(() => emit('export-request-data'), 100);

            // --- å°åˆ· ---
            document.getElementById('btn-print')?.addEventListener('click', () => {
                window.print();
            });

            // --- HTMLä¿å­˜ ---
            document.getElementById('btn-html')?.addEventListener('click', async () => {
                const path = await save({ filters: [{ name: 'HTML', extensions: ['html'] }] });
                if (path && contentDiv) {
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åŸ‹ã‚è¾¼ã‚€
                    const currentFont = contentDiv.style.fontFamily;
                    const currentSize = contentDiv.style.fontSize;
                    const currentLineHeight = contentDiv.style.lineHeight;

                    const style = `
            <style>
                body {
                    background-color: #555;
                    margin: 0;
                    padding: 20px;
                    display: flex;
                    justify-content: center;
                }
                /* ç´™é¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å†ç¾ */
                .paper {
                    background-color: white;
                    color: black;
                    width: 210mm;
                    min-height: 297mm;
                    padding: 20mm;
                    box-sizing: border-box; /* ã“ã‚ŒãŒé‡è¦ */
                    margin: 0 auto;
                    box-shadow: 0 0 10px rgba(0,0,0,0.5);
                    
                    /* ç¾åœ¨ã®è¨­å®šã‚’åæ˜  */
                    font-family: ${currentFont};
                    font-size: ${currentSize};
                    line-height: ${currentLineHeight};
                    word-wrap: break-word;
                }
                /* å°åˆ·æ™‚ã®è¨­å®š */
                @media print {
                    body { background: none; display: block; padding: 0; }
                    .paper { width: 100%; margin: 0; box-shadow: none; min-height: auto; }
                }
            </style>`;

                    // contentDivã®ä¸­èº«ã‚’ .paper ã‚¯ãƒ©ã‚¹ã®divã§åŒ…ã‚€
                    const fullHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8">${style}</head><body><div class="paper">${contentDiv.innerHTML}</div></body></html>`;

                    await invoke('write_file', { path, content: fullHtml, encoding: 'UTF-8' });
                    alert('ä¿å­˜ã—ã¾ã—ãŸ');
                }
            });

            // --- EPUBä¿å­˜ ---
            document.getElementById('btn-epub')?.addEventListener('click', async () => {
                epubTitleInput.value = "";
                epubModal.style.display = 'flex';
            });

            // --- è¡¨ç´™ç”»åƒé¸æŠ ---
            document.getElementById('btn-select-cover')?.addEventListener('click', async () => {
                const path = await window.__TAURI__.dialog.open({ // â€»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«åˆã‚ã›ã¦ä¿®æ­£ã—ã¦ãã ã•ã„
                    filters: [{ name: 'Image', extensions: ['jpg', 'jpeg', 'png'] }]
                });
                if (path) epubCoverPathInput.value = path;
            });

            document.getElementById('btn-clear-cover')?.addEventListener('click', () => {
                epubCoverPathInput.value = "";
            });

            // --- ã‚­ãƒ£ãƒ³ã‚»ãƒ« ---
            document.getElementById('btn-cancel-epub')?.addEventListener('click', () => {
                epubModal.style.display = 'none';
            });

            // --- å®Ÿè¡Œ (ä¿å­˜) ---
            document.getElementById('btn-exec-epub')?.addEventListener('click', async () => {
                const title = epubTitleInput.value || "Untitled";
                const author = epubAuthorInput.value || "Author";
                const coverPath = epubCoverPathInput.value || null;

                epubModal.style.display = 'none'; // å…ˆã«é–‰ã˜ã‚‹

                // ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                const path = await save({
                    defaultPath: title + ".epub",
                    filters: [{ name: 'EPUB Book', extensions: ['epub'] }]
                });

                if (path && contentDiv) {
                    const fileName = path.split(/[/\\]/).pop() || 'Untitled';
                    const title = fileName.replace(/\.[^/.]+$/, "");

                    // 1. HTMLã‚’è¡Œã”ã¨ã«åˆ†è§£ (ãƒ«ãƒ“ã‚¿ã‚°ç­‰ã¯ç¶­æŒã•ã‚Œã‚‹)
                    // MirrorShardã¯æ”¹è¡Œã‚’ <br> ã§è¡¨ç¾ã—ã¦ã„ã‚‹å‰æ
                    const rawHtml = contentDiv.innerHTML;
                    // <br> ã¾ãŸã¯ <br/> ã¾ãŸã¯ <br /> ã§åˆ†å‰²
                    const lines = rawHtml.split(/<br\s*\/?>/i);

                    const sections = [];
                    // åˆæœŸã‚»ã‚¯ã‚·ãƒ§ãƒ³
                    let currentSection = { title: title, content: "" };
                    let isFirstSectionEmpty = true; // å†’é ­ã®ç©ºã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®šç”¨

                    // 2. è¡Œã”ã¨ã«è§£æ
                    lines.forEach((line) => {
                        // ãƒˆãƒªãƒ ã—ã¦ç©ºè¡Œãƒã‚§ãƒƒã‚¯ï¼ˆãŸã ã—ãƒ«ãƒ“ã‚¿ã‚°ãªã©ãŒã‚ã‚‹ã®ã§æ…é‡ã«ï¼‰
                        const cleanLine = line.trim();

                        // â˜… Markdownè¦‹å‡ºã—ã®åˆ¤å®š (# ï¼‹ ã‚¹ãƒšãƒ¼ã‚¹ ï¼‹ æ–‡å­—åˆ—)
                        // HTMLã‚¿ã‚°ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ã‚¿ã‚°ã‚’é™¤å»ã—ã¦åˆ¤å®šã™ã‚‹ã‹ã€
                        // å˜ç´”ã«å…ˆé ­ä¸€è‡´ã‚’è¦‹ã‚‹ã€‚ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å…ˆé ­ä¸€è‡´ã‚’è¦‹ã‚‹ã€‚
                        // (ãƒ«ãƒ“ãŒè¦‹å‡ºã—ã«å«ã¾ã‚Œã‚‹ã“ã¨ã¯ç¨€ã¨ã„ã†å‰æ)
                        const match = cleanLine.match(/^(#+)\s+(.*)/);

                        if (match) {
                            // è¦‹å‡ºã—ãŒè¦‹ã¤ã‹ã£ãŸ

                            // å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ä¸­èº«ãŒã‚ã‚Œã°ä¿å­˜
                            if (!isFirstSectionEmpty || currentSection.content.trim() !== "") {
                                sections.push(currentSection);
                            }

                            const level = match[1].length; // # ã®æ•°
                            const headingText = match[2]; // è¦‹å‡ºã—æœ¬æ–‡

                            // æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
                            currentSection = {
                                title: headingText, // ã“ã‚ŒãŒç›®æ¬¡ã«ãªã‚‹
                                // æœ¬æ–‡ã«ã¯ <h1>è¦‹å‡ºã—</h1> ã¨ã—ã¦è¿½åŠ 
                                content: `<h${level}>${headingText}</h${level}>`
                            };
                            isFirstSectionEmpty = false;

                        } else {
                            // é€šå¸¸ã®è¡Œ
                            if (cleanLine !== "") {
                                // æ®µè½ <p> ã¾ãŸã¯å˜ç´”ãªæ”¹è¡Œã¨ã—ã¦è¿½åŠ 
                                // EPUB (XHTML) ãªã®ã§ <br /> ã‚’ä»˜ä¸
                                currentSection.content += `<p>${line}</p>`;
                            }
                        }
                    });

                    // æœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
                    if (currentSection.content.trim() !== "") {
                        sections.push(currentSection);
                    }

                    // 3. ã‚µãƒ‹ã‚¿ã‚¤ã‚º (XHTMLåŒ–)
                    const sanitizedSections = sections.map(sec => {
                        return {
                            title: sec.title,
                            content: sec.content
                                .replace(/&nbsp;/g, '&#160;')
                                // <p>ã‚¿ã‚°ã§å›²ã‚“ã ã®ã§ <br> ç½®æ›ã¯ä¸è¦ã‹ã‚‚ã—ã‚Œãªã„ãŒã€
                                // lineã®ä¸­ã«æ®‹ã£ã¦ã„ã‚‹ã‚¿ã‚°ãŒã‚ã‚Œã°é–‰ã˜ã‚‹å‡¦ç†ãŒå¿…è¦
                                .replace(/<hr>/g, '<hr />')
                        };
                    });

                    // Rustã¸é€ä¿¡ (sanitizedSections ã‚’é€ã‚‹)

                    try {
                        await invoke('export_epub', {
                            path,
                            title,
                            author,
                            coverPath,
                            sections: sanitizedSections,
                        });
                        alert('EPUBãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ');
                    } catch (e) {
                        console.error(e);
                        alert('EPUBä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e);
                    }
                }
            });


            // é–‰ã˜ã‚‹
            document.getElementById('btn-close')?.addEventListener('click', () => getCurrentWindow().close());

            // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
            document.addEventListener('keydown', (e) => {
                const isCtrlOrCmd = e.ctrlKey || e.metaKey;
                if (isCtrlOrCmd && e.key.toLowerCase() === 'p') {
                    e.preventDefault();
                    window.print();
                }
                if (isCtrlOrCmd && e.key.toLowerCase() === 'e') {
                    e.preventDefault();
                    getCurrentWindow().close();
                }
            });
        }
        window.addEventListener('DOMContentLoaded', initExport);
    </script>
</body>

</html>